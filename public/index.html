<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Invisible</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: url('BACKGROUND.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: rgba(255, 255, 255, 0.5);
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }
        h1, h2, h3, p {
            color: #B22222;
        }
        h4, p {
                color: #020000;
        }
        
        .hidden {
            display: none;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .mt-aligned {
            margin-top: 90vh;
        }
        #perfil-juego,
        #nuevo-juego,
        #pantalla-juego {
            margin-top: 0px;
            padding-top: 20px; /* AÃ±ade un pequeÃ±o espacio si es necesario */
            overflow-y: auto; /* Permite el desplazamiento si el contenido es muy largo */
            max-height: calc(100vh - 40px); /* Ajusta la altura mÃ¡xima para evitar que se corte */
        }
        #presupuesto-juego,
        #presupuesto-sorteo,
        #fecha-entrega,
        #fecha-sorteo,
        #mensaje-juego,
        #nombre-administrador {
            font-size: 24px; /* Cambia el tamaÃ±o de la letra segÃºn tus necesidades */
            font-weight: bold; /* Pone la letra en negrita */
            color:#B22222;
        }
        nav {
            background-color: rgba(255, 255, 255, 0.8); /* Fondo semitransparente */
            z-index: 1000; /* AsegÃºrate de que estÃ© por encima del contenido */
        }
        /* Estilo general para todos los botones */
        button, .btn, .perfil-juego-btn {
            background-color: #ff0000;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 10px;
            margin: 10px;
            pointer-events: auto !important;
        }

        /*hover para todos los botones */
        button:hover, .btn:hover, .perfil-juego-btn:hover {
            background-color: #000000;
        }


    </style>
</head>    
    
<body class="flex flex-col items-center justify-center h-screen text-center">
    <nav class="fixed top-0 left-0 w-full bg-white bg-opacity-80 p-4 flex justify-between items-center">
        <ul class="flex space-x-4">
           <li><button class="btn" onclick="salirJuego()">Salir</button></li>
        </ul>
    </nav>
    
    <div class="bg-white bg-opacity-80 p-8 rounded-lg shadow-lg max-w-2xl mt-aligned">
        <!-- Pantalla inicial con opciones -->
        <div id="inicio">
            <h1 class="text-4xl font-bold mb-4">Â¡Bienvenid@ al juego del Amigo Invisible!</h1>
            <br>
            <p class="mb-4 text-xl">Â¡Con regalos secretos y risas para soÃ±ar, <br>Â¡este Amigo Invisible te va a enganchar! ğŸ</p>
            <button class="btn" onclick="nuevoJuego()">ğŸ„ Crea tu grupo ğŸ„</button>
            <button class="btn" onclick="insertarCodigo()">ğŸ Inserta CÃ³digo (o email si creaste tu el grupo) ğŸ</button>
        </div>

        <!-- SecciÃ³n Nuevo Juego (Administrador) -->
        <div id="nuevo-juego" class="hidden">
            <h2 class="text-3xl font-bold">Â¡TÃº ahora eres lÃ­der y quien gestiona la diversiÃ³n! ğŸ‰</h2>
            <h2 class="text-3xl font-bold">Con tu toque mÃ¡gico, Â¡serÃ¡ una gran funciÃ³n!  ğŸ‰</h2>
            <br>
            <h3 class="text-2xl font-bold"> Prepara tus trucos y tu varita especialğŸª„...</h3>
            <h3 class="text-2xl font-bold">Realiza tus misiones y seguro que todo saldrÃ¡ fenomenal!</h3>
            <ul class="list-disc list-inside mt-4 text-left">
                <li>ğŸ“Tu primer encargo: el formulario a continuaciÃ³n rellenar, y asÃ­ el juego poder generar.</li>
                <li>ğŸ‘¥DepuÃ©s, el cÃ³digo del juego a todos compartir, para que nadie se pierda y que todos puedan asistir.</li>
                <li>ğŸ”’Si alguien la contraseÃ±a olvida no hay que temer, tÃº tendrÃ¡s la clave para pronto proceder.</li>
                <li>ğŸ“…El sorteo en el dÃ­a seÃ±alado realizar y la fecha de entrega fijar, Â¡QuÃ© todo estÃ© listo, no se puede atrasar!</li>
                <li>ğŸ’°Por Ãºltimo no olvides anotar, el presupuesto que todos podrÃ¡n gastar.</li>
            </ul>
            <p>Ahora sÃ­...Â¡manos a la obra! Seguro que serÃ¡s el mejor anfitriÃ³n, y todos gritarÃ¡n de emociÃ³n!</p>
            <form id="admin-form">
                <label for="admin-nombre">ğŸ“Escribe tu nombre aquÃ­,no te hagas de rogar! Â¡AsÃ­ todos sabrÃ¡n quiÃ©n va a mandar:
                    <input id="admin-nombre" class="input-field" type="text" placeholder="Nombre del administrador"required>
                </label>
                <label for="admin-email">ğŸ“§Â¡Ahora anota tu email sin demorar! Â¡Para recuperar el juego si el cÃ³digo se echa a volar!:
                    <input id="admin-email" class="input-field" type="email" placeholder="Email del administrador"required>
                </label>
                <label for="admin-password">ğŸ”’Inventa una clave especial y que sea tu secreto mÃ¡s personal!
                    <input id="admin-password" class="input-field" type="password" placeholder="ContraseÃ±a" required>
                </label>
                <label for="nombre-grupo">ğŸ‘¥Â¡Ponle nombre a tu grupo, no seas tÃ­mido! Â¡Hazlo Ãºnico y divertido!
                    <input id="nombre-grupo" class="input-field" type="text" placeholder="Nombre del grupo" required>
                </label>
                <label for="admin-presupuesto">ğŸ’°Establece el presupuesto sin tardar, asÃ­ todos sabrÃ¡n cuÃ¡nto podrÃ¡n gastar:
                    <input id="admin-presupuesto" class="input-field" type="number" placeholder="Presupuesto en euros" required>
                </label>
                <label for="admin-fecha-sorteo">ğŸ“…El dÃ­a del sorteo debes elegir, para que la magia se pueda cumplir
                    <input id="admin-fecha-sorteo" class="input-field" type="date" required>
                </label>
                <label for="admin-fecha-entrega">ğŸEl dÃ­a especial pronto llegarÃ¡, pero antes la fecha aquÃ­ debes apuntar:
                    <input id="admin-fecha-entrega" class="input-field" type="date" required>
                </label>
                <label for="admin-mensaje">ğŸ“©Escribe un mensaje si quieres asombrar, o deja el espacio si prefieres callar:
                    <textarea id="admin-mensaje-grupo" class="input-field" placeholder="Mensaje de bienvenida"></textarea>
                </label>
                <label for="admin-participantes">ğŸ“ğŸ‘¥Anota los nombres sin vacilaciÃ³n, de todos los que quieren entrar en acciÃ³n:
                    <textarea id="admin-participantes" class="input-field" placeholder="Introduce un nombre por lÃ­nea" required></textarea>
                </label>
                <button type="button" class="btn" onclick="crearJuego()">ğŸ… Generar Juego ğŸ…</button>
            </form>
        </div>
        <!-- SecciÃ³n Insertar CÃ³digo -->
        <div id="insertar-codigo" class="hidden">
            <h2 class="text-3xl font-bold">Para unirte al juego y empezar a disfrutar, <br>escribe el cÃ³digo... Â¡y listo para jugar!. </h2>
            <br>
            <h4 class="text-xl font-bold">Si tÃº creaste el grupo, tu email tambiÃ©n puedes ingresar, <br>Â¡asÃ­ entrar y todo controlar!</h4>
            <input type="text" id="codigo-juego" class="border p-2 rounded w-full mt-2" placeholder="CÃ³digo o Email">
            <button type="button" class="btn mt-4" onclick="accederJuego()">Acceder al Juego</button>
        </div>

        <!-- Pantalla de Juego (Listado de Participantes) -->
        <div id="pantalla-juego" class="hidden">
            <h1 class="text-3xl font-bold">Te doy la bienvenida al juego del Amigo Invisible de... <br><span id="nombre-grupo-juego" style="font-style: italic;"></span></h1>
            <h2>(CÃ³digo del juego: <span id="info-codigo-juego"></span>)</h2>
            <br>
            <h4 class="text-2xl font-bold">Con estos datos ya verÃ¡s, <br>como con este juego un montÃ³n disfrutarÃ¡s.ğŸ‰</h4>
            <br>
            <p>ğŸ’°AquÃ­ tienes el tope a gastar, ahora ya sabes cuÃ¡nto desembolsar!:<br> <span id="presupuesto-juego"></span> â‚¬</p>
            <p>ğŸ“…Esta la fecha del sorteo es, todo estÃ¡ preparado, Â¿lo ves??:<br><span id="fecha-sorteo"></span></p>
            <p>ğŸÂ¡A continuaciÃ³n el dÃ­a mÃ¡s especial, nos entregaremos los regalos Â¡SerÃ¡ genial!:<br> <span id="fecha-entrega"></span></p>
            <p>ğŸ“©QuizÃ¡s leas aquÃ­ un mensaje Â¡quÃ© ilusiÃ³n! pero sino... Â¡no pierdas la emociÃ³n!:<br><span id="mensaje-juego"></span></p>
            <p>ğŸ¤¯Esta es la persona que este grupo ha creado, Â¡si algo no te cuadra, dÃ­selo sin reparo!: <br><span id="nombre-administrador"></span></p>

            
            <h3 class="text-2xl font-bold mt-4">Â¡Con todo acordado... este juego ya estÃ¡ casi preparado!</h3>
            <h3 class="text-2xl font-bold mt-4">Â¡Solo falta estos pasos seguir y verÃ¡s todo fluir!</h3>
            <h4 class="text-xl font-bold mt-4">â¡ï¸Â¡Comienza por tu perfil gestionar, <br>y pronto el juego comenzarÃ¡ a brillar âœ¨!:</h4>
            <h4 class="text-xl font-bold mt-4">â¡ï¸ContinÃºa echando un vistazo a tu amigo invisible, <br>descubre lo que ha deseado para hacerlo posible. ğŸ</h4>
            <h4 class="text-xl font-bold mt-4">â¡ï¸Por ÃºltimoğŸ¤«a los demÃ¡s tambiÃ©n puedes cotillear,<br> para asÃ­ poderte inspirarğŸ˜‰:</h4>
            <ul id="lista-participantes" class="text-left mt-4"></ul>
        </div>

        <!-- Perfil del Administrador -->
             
        <div id="perfil-administrador" class="hidden">
            <h2 class="text-2xl font-bold">Te doy la bienvenida, mente ğŸ¤¯creadora del GRUPO</h2>
            <br>
            <h4 class="text-xl font-bold">ğŸ® Si quieres jugar y disfrutar, <br>en tu perfil PERSONAL debes entrar. <br>ğŸ“‹ Pero si organizar es tu misiÃ³n, <br>el perfil del GRUPO es tu elecciÃ³n.:</h4>
            <br>
            <h2 class="text-2xl font-bold">Elige tu opciÃ³n:</h2>
           
        </div>
        
        <div id="opciones-perfil" class="hidden">
            <button class="btn" onclick="verPerfilJuego()">Gestionar perfil del GRUPO</button>
            <button id="btn-ver-perfil-personal" class="btn">Gestionar tu perfil PERSONAL</button>

        </div>
        
        
        <div id="perfil-juego" class="hidden">
            <h2 class="text-2xl font-bold">ğŸ“Te doy la bienvenida aquÃ­ donde todo se puede cambiar, ğŸ“ŠğŸ”§ğŸ˜„ <br>Â¡Contigo al mando nada va a fallar!:</h2>
            <br>
            <label><strong>ğŸ’°Este es el tope a gastar, Â¿estÃ¡ bien o lo vas a cambiar?:</strong>
                <input id="admin-presupuesto-mostrar" class="input-field" type="number">
            </label>
            <label><strong>ğŸAquÃ­ estÃ¡ la fecha especial. Â¿Hay algÃºn cambio adicional?:</strong>
                <input id="admin-fecha-entrega-mostrar" class="input-field" type="date">
            </label>
            <label><strong>ğŸ“©En este lugar un mensaje para tu grupo puedes anotar, Â¿les quieres asombrar o prefieres callar?:</strong>
                <textarea id="admin-mensaje-mostrar" class="input-field"></textarea>
            </label>
            <label><strong>ğŸ“…Esta es la fecha del sorteo, no la dejes pasar... Â¿La quieres modificar?:</strong>
                <input id="admin-fecha-sorteo-mostrar" class="input-field" type="date">
            </label>
            <br>
            <p> ğŸ¤«Â¿Alguien la contraseÃ±a olvidÃ³? Pues dale el cÃ³digo <strong>123</strong> y todo se solucionÃ³. ğŸ”’</p>
            <br>
            <h4 class="text-xl font-bold mt-4">ğŸ§Participantes a la vista!, ahora puedes eliminar o agregar a la lista. ğŸ“‹</h4>
            <ul id="lista-participantes-admin" class="text-left mt-4"></ul>
            <h4 class="text-xl font-bold mt-4">Â¿Quieres unir a mÃ¡s personas a la diversiÃ³n? Entonces hazlo a continuaciÃ³n:
            <input id="nuevo-participante-nombre" class="input-field" type="text" placeholder="Nombre del participante">
            <button class="btn perfil-juego-btn" onclick="agregarParticipante()">AÃ‘ADIR PARTICIPANTE</button>
          
            <br>
            <p><strong>ğŸ“…Â¿Ha llegado el dÃ­a seÃ±alado?<br> Â¡Pues corre! Realiza el sorteo y sabrÃ©is quiÃ©n os ha tocado:</strong></p>
            <br>
            <button class="btn perfil-juego-btn" onclick="realizarSorteo()">REALIZAR SORTEO</button>
            <br>
            <button class="btn perfil-juego-btn" onclick="actualizarJuego()">ACTUALIZAR INFO DEL GRUPO</button>
            <br>
            <button class="btn perfil-juego-btn" onclick="eliminarJuego()">ELIMINAR GRUPO</button>
            <br>
            <button class="btn perfil-juego-btn" onclick="mostrarInformacionJuego()">VOLVER A LA PANTALLA DEL GRUPO</button>
        </div>
        
        <div id="perfil-personal" class="mt-4 hidden">
            <h2 class="text-xl font-bold">Este es tu perfil personal,<br> Â¡ajÃºstalo si necesitas cambiar algo en especial!:</h2>
            <label><strong>Nombre:</strong>
                <input id="perfil-nombre" class="input-field" type="text" readonly>
            </label>
            
            <br>
            <label><strong>Elige tu avatar, ese que te haga brillarâœ¨:</strong>
                <select id="perfil-avatar" class="input-field">
                    <option value="ğŸ…">ğŸ… Santa</option>
                    <option value="ğŸ„">ğŸ„ Ãrbol de Navidad</option>
                    <option value="â„ï¸">â„ï¸ Copo de nieve</option>
                    <option value="ğŸ¦Œ">ğŸ¦Œ Reno</option>
                    <option value="ğŸ">ğŸ Regalo</option>
                    <option value="ğŸ§¦">ğŸ§¦ Calcetines</option>
                    <option value="ğŸ—">ğŸ— Pavo</option>
                    <option value="ğŸ§‘â€ğŸ„">ğŸ§‘â€ğŸ„ Navidad</option>
                    <option value="ğŸ·">ğŸ· Vino</option>
                    <option value="ğŸŒŸ">ğŸŒŸ Estrella</option>
                    <option value="ğŸ¾">ğŸ¾ Botella</option>
                    <option value="ğŸ§">ğŸ§ PingÃ¼ino</option>
                    <option value="ğŸ‘µ">ğŸ‘µ Abuela</option>
                    <option value="â›„">â›„ Snowman</option>
                    <option value="ğŸ¶">ğŸ¶ Perro</option>
                    <option value="ğŸ¥">ğŸ¥ Pollito</option>
                    <option value="ğŸ‰">ğŸ‰ Fiesta</option>
                    <option value="ğŸ›·">ğŸ›· Trineo</option>
                    <option value="ğŸ‘©â€ğŸ¦°">ğŸ‘©â€ğŸ¦° Mujer</option>
                    <option value="ğŸ¥‚">ğŸ¥‚ Brindis</option>
                    <option value="ğŸ‘´">ğŸ‘´ Abuelo</option>
                    <option value="ğŸª">ğŸª Galleta</option>
                    <option value="ğŸ•¯ï¸">ğŸ•¯ï¸ Vela</option>
                    <option value="ğŸ¤¶">ğŸ¤¶ Mama Noel</option>
                    <option value="ğŸ‘¼">ğŸ‘¼ Angel</option>
                    <option value="ğŸ‘¨">ğŸ‘¨ Hombre</option>
                    <option value="ğŸ‘§">ğŸ‘§ Chica</option>
                </select>
            </label>
            <label><strong>Escribe al menos tres cosas que anheles tener <br> desde juguetes, libros o algo de comer. <br> Si se online se puede comprar, <br>aÃ±ade el link para no fallar:</strong>
                <textarea id="perfil-deseos" class="input-field"></textarea>
            </label>
            <label><strong>Para tu amigo invisible un mensaje deja sin reparo... âœ‰ï¸ğŸ Â¿Te sientes inspirado? </strong>
                <textarea id="admin-mensaje" class="input-field"></textarea>
            </label>
            <h2 class="text-xl font-bold"><strong>Te ha tocado regalar a...</strong> <span id="amigo-invisible-admin"></span></h2>
                <br>
            <p><strong>Â¡PrepÃ¡rate para sorprender con un regalo que le haga enloquecer!</strong></p>
            
                <button class="btn" onclick="actualizarPerfilAdministrador()">ACTUALIZAR PERFIL</button>
                <button class="btn" onclick="mostrarInformacionJuego()">VOLVER AL JUEGO</button>
        </div>
        
        
        <!-- Perfil de Participante -->
        <div id="perfil-participante" class="hidden">
            <h2 class="text-3xl font-bold">Perfil de: <span id="perfil-nombre-participante"></span></h2>
            <h2 class="text-2xl font-bold">Este es tu espacio personal,<br> Â¡ajusta los datos si necesitas cambiar algo en especial!</h2>
                        
            <br>
            <label><strong>Elige tu avatar, ese que te haga brillarâœ¨:</strong>
                <select id="participante-avatar" class="input-field">
                    <option value="ğŸ…">ğŸ… Santa</option>
                    <option value="ğŸ„">ğŸ„ Ãrbol de Navidad</option>
                    <option value="â„ï¸">â„ï¸ Copo de nieve</option>
                    <option value="ğŸ¦Œ">ğŸ¦Œ Reno</option>
                    <option value="ğŸ">ğŸ Regalo</option>
                    <option value="ğŸ§¦">ğŸ§¦ Caldetines</option>
                    <option value="ğŸ—">ğŸ— Pavo</option>
                    <option value="ğŸ§‘â€ğŸ„">ğŸ§‘â€ğŸ„ Navidad</option>
                    <option value="ğŸ·">ğŸ· Vino</option>
                    <option value="ğŸŒŸ">ğŸŒŸ Estrella</option>
                    <option value="ğŸ¾">ğŸ¾ Botella</option>
                    <option value="ğŸ§">ğŸ§ PingÃ¼ino</option>
                    <option value="ğŸ‘µ">ğŸ‘µ Abuela</option>
                    <option value="â›„">â›„ Snowman</option>
                    <option value="ğŸ¶">ğŸ¶ Perro</option>
                    <option value="ğŸ¥">ğŸ¥ Pollito</option>
                    <option value="ğŸ‰">ğŸ‰ Fiesta</option>
                    <option value="ğŸ›·">ğŸ›· Trineo</option>
                    <option value="ğŸ‘©â€ğŸ¦°">ğŸ‘©â€ğŸ¦° Mujer</option>
                    <option value="ğŸ¥‚">ğŸ¥‚ Brindis</option>
                    <option value="ğŸ‘´">ğŸ‘´ Abuelo</option>
                    <option value="ğŸª">ğŸª Galleta</option>
                    <option value="ğŸ•¯ï¸">ğŸ•¯ï¸ Vela</option>
                    <option value="ğŸ¤¶">ğŸ¤¶ Mama Noel</option>
                    <option value="ğŸ‘¼">ğŸ‘¼ Angel</option>
                    <option value="ğŸ‘¨">ğŸ‘¨ Hombre</option>
                    <option value="ğŸ‘§">ğŸ‘§ Chica</option>
                </select>
            </label>
            <label><strong>Escribe al menos tres cosas que anheles tener <br> desde juguetes, libros o algo de comer. <br> Y si se puede comprar online sin estrÃ©s, <br>aÃ±ade el link para hacerlo aÃºn mÃ¡s fÃ¡cil, Â¡ya ves!:</strong>
                <textarea id="participante-deseos" class="input-field"></textarea>
            </label>
            <label><strong>Para tu amigo invisible un mensaje deja sin reparo... âœ‰ï¸ğŸ Â¿Te sientes inspirado?</strong>
                <textarea id="participante-mensaje2" class="input-field"></textarea>
            </label>
            <br>
            <br>
            <h2 class="text-xl font-bold"><strong>Te ha tocado regalar a...</strong> <span id="amigo-invisible-participante"></span></h2>
            <br>
            <p><strong>Â¡PrepÃ¡rate para sorprender con un regalo que le haga enloquecer!</strong></p>
            <br>
            <button class="btn" onclick="actualizarPerfilParticipante()">Actualizar Perfil</button>
            <button class="btn" onclick="mostrarInformacionJuego()">VOLVER AL JUEGO</button>
        </div>
        
        <div id="perfil-participante-ver" class="hidden">
            <h2 class="text-3xl font-bold">Perfil de: <span id="perfil-nombre-participante-ver"></span></h2>
            <label><strong>Este es el avatar que mÃ¡s me hace brillar:</strong>
                <input id="participante-avatar-ver" class="input-field" type="text" readonly>
            </label>
            <label><strong>Esta es mi lista de deseos, Ã©chale un vistazo y... Â¡cumple mis anhelosğŸŒŸğŸ!:</strong>
                <textarea id="participante-deseos-ver" class="input-field" readonly></textarea>
            </label>
            <label><strong> Este es el mensaje que quizÃ¡s haya dejado... Â¿ya lo has ojeado?</strong>
                <textarea id="participante-mensaje" class="input-field" readonly></textarea>
            </label>
            <!-- BotÃ³n para volver a la pantalla de juego -->
            <button class="btn" onclick="mostrarInformacionJuego()">VOLVER AL JUEGO</button>
        </div>

        <div id="perfil-admin-ver" class="hidden">
            <h2 class="text-3xl font-bold">Perfil de: <span id="perfil-nombre-admin-ver"></span></h2>
            <label><strong>Este es el avatar que mÃ¡s me hace brillar:</strong>
                <input id="admin-avatar-ver" class="input-field" type="text" readonly>
            </label>
            <label><strong>Esta es mi lista de deseos, Ã©chale un vistazo y... Â¡cumple mis anhelosğŸŒŸğŸ!:</strong>
                <textarea id="admin-deseos-ver" class="input-field" readonly></textarea>
            </label>
            <label><strong>Este es el mensaje que quizÃ¡s haya dejado... si me encontraba inspirad@ ğŸ˜‰:</strong>
                <textarea id="admin-mensaje-ver" class="input-field" readonly></textarea>
            </label>
            <!-- BotÃ³n para volver a la pantalla de juego -->
            <button class="btn" onclick="mostrarInformacionJuego()">VOLVER AL JUEGO</button>
        </div>
        
    <!-- Scripts de Firebase y configuraciÃ³n -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
            import {  getFirestore, serverTimestamp, query, where, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // ConfiguraciÃ³n de Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyClZpeQVJAy2lvFOdXJSYz5LIl1ZIYQJ88",
                authDomain: "amigo-invisible-98413.firebaseapp.com",
                projectId: "amigo-invisible-98413",
                storageBucket: "amigo-invisible-98413.appspot.com", // Ajustado a "appspot.com"
                messagingSenderId: "362605855318",
                appId: "1:362605855318:web:c62743248a73ac042271f7",
                measurementId: "G-53VTRP1TT0"
            };
        
            // Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getFirestore(app);
            
           
            let codigoActual = null;
            let juegoActual = null;
          
            // FunciÃ³n para generar y guardar el cÃ³digo de juego en Firestore
            window.nuevoJuego = function() {
          
                // Genera el cÃ³digo de juego y lo almacena
                const codigoJuego = Math.random().toString(36).substr(2, 9);

                // Oculta la pantalla de inicio y muestra el formulario para crear el juego
                document.getElementById('inicio').classList.add('hidden');
                document.getElementById('pantalla-juego').classList.add('hidden');
                document.getElementById('nuevo-juego').classList.remove('hidden');

                // Agregar un event listener al botÃ³n "Generar Juego"
                document.getElementById('boton-generar-juego').onclick = function() {
                    // Referencia a la colecciÃ³n 'juegos'
                    const juegosCol = collection(db, 'juegos');

                    // Agregar un nuevo documento a la colecciÃ³n
                    addDoc(juegosCol, {
                        codigo: codigoJuego,
                        timestamp: serverTimestamp() // Uso de serverTimestamp() de la forma correcta
                    })
                    .then(function(docRef) {
                    
                        alert("CÃ³digo de grupo generado: " + codigoJuego); // Muestra el cÃ³digo generado
                    })
                    .catch(function(error) {
                        console.error("Error al guardar el cÃ³digo de grupo: ", error);
                    });
                };
            };

            
            // LÃ³gica para insertar insertar codigo al juego
            
            window.insertarCodigo = function() {
  

                // Muestra la secciÃ³n para insertar el cÃ³digo
                document.getElementById('insertar-codigo').classList.remove('hidden');

                // Opcionalmente, oculta cualquier otra pantalla
                document.getElementById('pantalla-juego').classList.add('hidden');
            };

            // LÃ³gica para  acceder al juego

            window.accederJuego = function() {
                
                const input = document.getElementById('codigo-juego').value;
                const codigo = input.trim();

                // Verifica si hay un cÃ³digo ingresado
                if (!codigo) {
                    alert("Por favor, introduce un cÃ³digo o email.");
                    return; // Salimos de la funciÃ³n si no hay entrada
                }

                // Si el usuario ingresa un email en lugar de un cÃ³digo
                if (codigo.includes("@")) {
                    // Buscar todos los documentos en la colecciÃ³n "juegos" que coincidan con el email ingresado
                    const juegosRef = collection(db, "juegos");
                    const queryEmail = query(juegosRef, where("administrador.email", "==", codigo));

                    getDocs(queryEmail).then(snapshot => {
                        if (!snapshot.empty) {
                            const juegos = [];
                            snapshot.forEach(doc => {
                                juegos.push({ codigo: doc.id, nombreGrupo: doc.data().nombreGrupo });
                            });

                            // Si hay mÃ¡s de un juego asociado con el email
                            if (juegos.length > 1) {
                                const opciones = juegos.map(juego => `${juego.nombreGrupo} (CÃ³digo: ${juego.codigo})`).join("\n");
                                const seleccion = prompt(`Elige el grupo al que deseas acceder:\n${opciones}`);

                                // Buscar el cÃ³digo seleccionado en la lista de juegos
                                const juegoSeleccionado = juegos.find(j => seleccion.includes(j.codigo));
                                if (juegoSeleccionado) {
                                    cargarJuego(juegoSeleccionado.codigo);
                                } else {
                                    alert("SelecciÃ³n invÃ¡lida. Por favor, intenta de nuevo.");
                                }
                            } else {
                                // Si solo hay un grupo asociado, acceder directamente
                                cargarJuego(juegos[0].codigo);
                            }
                        } else {
                            alert("No se encontraron juegos asociados con este email.");
                        }
                    }).catch(error => {
                        console.error("Error al buscar juegos por email: ", error);
                    });
                } else {
                    // Si se ingresa un cÃ³digo, intentar cargar el juego directamente
                    cargarJuego(codigo);
                }
            };


            window.cargarJuego = function(codigo) {
                getDoc(doc(db, "juegos", codigo))
                    .then(doc => {
                        if (doc.exists()) {
                            juegoActual = doc.data();
                            codigoActual = codigo;

                            // Log para verificar los datos cargados del administrador
                          

                            // Verificar y asignar administrador temporal si no existe
                            verificarYAsignarAdminTemporal();

                            // Inicializar `mensajeAmigo` del administrador si no existe
                            if (!juegoActual.administrador.mensajeAmigo) {
                                juegoActual.administrador.mensajeAmigo = "";
                            }

                            // Verificar y mostrar logs para depuraciÃ³n
                          

                            // Ocultar el div de insertar cÃ³digo y mostrar la pantalla de juego
                            const insertarCodigoDiv = document.getElementById('insertar-codigo');
                            const pantallaJuegoDiv = document.getElementById('pantalla-juego');
                            if (insertarCodigoDiv && pantallaJuegoDiv) {
                                insertarCodigoDiv.classList.add('hidden');
                                pantallaJuegoDiv.classList.remove('hidden');
                       
                            } else {
                                console.error("No se encontraron los elementos 'insertar-codigo' o 'pantalla-juego'.");
                            }

                            // Llamar a la funciÃ³n para mostrar la informaciÃ³n del juego
                            mostrarInformacionJuego();
                        } else {
                            alert("CÃ³digo incorrecto.");
                        }
                    })
                    .catch(error => {
                        console.error("Error al acceder al juego:", error);
                    });
            };

            window.verificarYAsignarAdminTemporal = function () {
                // Verificar si el administrador no existe en la lista de participantes
                const adminNombre = juegoActual.administrador?.nombre;
                const adminExiste = juegoActual.participantes.some(p => p.nombre === adminNombre);

                if (!adminExiste) {
                    alert("No se encontrÃ³ administrador para este juego. Se asignarÃ¡ un administrador temporal.");

                    // Asignar al primer participante como administrador temporal
                    const nuevoAdmin = juegoActual.participantes[0];
                    juegoActual.administrador = {
                        nombre: nuevoAdmin.nombre,
                        email: nuevoAdmin.email || "",
                        password: nuevoAdmin.password || "123"
                    };

                    // Actualizar el participante asignado como administrador
                    nuevoAdmin.esAdministrador = true;
                                // **Actualizar inmediatamente la interfaz**
                    document.getElementById('nombre-administrador').textContent = nuevoAdmin.nombre;
                    // Guardar los cambios en Firestore
                    updateDoc(doc(db, "juegos", String(codigoActual)), {
                        administrador: juegoActual.administrador,
                        participantes: juegoActual.participantes
                    }).then(() => {
                        
                        alert(`Se ha asignado como administrador temporal a: ${nuevoAdmin.nombre}`);
                        
                        
                    }).catch(error => {
                        console.error("Error al asignar el administrador temporal:", error);
                    });
                }
            };


            // LÃ³gica para mostrar la fecha
            window.formatoFecha = function(fecha) {
                if (!fecha) return ""; // Verificar que la fecha no sea nula
                const date = new Date(fecha);
                return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            };


            // LÃ³gica para crear nuevo juego
            
            window.crearJuego = function() {
                const participantesInputValue = document.getElementById('admin-participantes').value.trim().split('\n').map(nombre => nombre.trim());
               
                // Verificar nombres duplicados
                const nombresUnicos = new Set(participantesInputValue);
                if (nombresUnicos.size !== participantesInputValue.length) {
                    alert("Listado no vÃ¡lido: Hay nombres duplicados. Por favor, introduce nombres Ãºnicos.");
                    return;
                }

               
                const codigo = Math.floor(1000 + Math.random() * 9000);
                const nombreGrupo = document.getElementById('nombre-grupo').value;
                const nombre = document.getElementById('admin-nombre').value;
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                const presupuesto = document.getElementById('admin-presupuesto').value;
                const fechaSorteo = document.getElementById('admin-fecha-sorteo').value;
                const fechaEntrega = document.getElementById('admin-fecha-entrega').value;
                const mensaje = document.getElementById('admin-mensaje-grupo').value;

                const participantes = participantesInputValue.map(nombre => ({
                    nombre: nombre,
                    avatar: "",
                    deseos: "",
                    password: "",
                    amigoInvisible: "",
                    mensajeAmigo: "",
                    esAdministrador: false // No son administradores por defecto
                })).filter(part => part.nombre);

                // Incluir al administrador como participante
                participantes.push({
                    nombre: nombre,
                    email: email,
                    avatar: "",
                    deseos: "",
                    password: password,
                    amigoInvisible: "",
                    mensajeAmigo: "",
                    esAdministrador: true // Este es el administrador
                });

                juegoActual = {
                    codigo: codigo,
                    nombreGrupo: nombreGrupo,
                    administrador: { nombre, email, password },
                    presupuesto,
                    fechaSorteo,
                    fechaEntrega,
                    mensaje,
                    participantes
                };

                // Guardar el juego en Firestore
                setDoc(doc(db, "juegos", String(codigo)), juegoActual).then(() => {
                    alert(`Juego creado con Ã©xito. CÃ³digo: ${codigo}`);
                    document.getElementById('nuevo-juego').classList.add('hidden');
                    document.getElementById('pantalla-juego').classList.remove('hidden');
                    mostrarInformacionJuego();
                }).catch(error => {
                    console.error("Error al guardar el juego: ", error);
                });
            };
                        // LÃ³gica para agregar participante
            window.agregarParticipante = function() {
                    const nombreNuevoParticipante = document.getElementById('nuevo-participante-nombre').value.trim();

                    if (nombreNuevoParticipante === "") {
                        alert("Por favor, introduce un nombre vÃ¡lido para el participante.");
                        return;
                    }

                    // Verificar si el nombre ya existe en la lista de participantes
                    if (juegoActual.participantes.some(p => p.nombre === nombreNuevoParticipante)) {
                        alert("El nombre del participante ya existe. Por favor, introduce un nombre diferente.");
                        return;
                    }

                    // AÃ±adir el nuevo participante a la lista
                    juegoActual.participantes.push({
                        nombre: nombreNuevoParticipante,
                        avatar: "",
                        deseos: "",
                        password: "",
                        amigoInvisible: "",
                        mensajeAmigo: ""
                    });

                
                // Guardar los cambios en Firestore
                updateDoc(doc(db, "juegos", String(codigoActual)), {
                        participantes: juegoActual.participantes
                    }).then(() => {
                        alert("Â¡Participante aÃ±adido con Ã©xito!");
                        // Actualizar la lista despuÃ©s de que el usuario cierra la alerta
                        actualizarListaParticipantesAdmin();
                        document.getElementById('nuevo-participante-nombre').value = "";
                    }).catch(error => {
                        console.error("Error al agregar participante: ", error);
                });
            };

            
            window.mostrarInformacionJuego = function () {
              
                
                // Verificar si el administrador todavÃ­a existe en la lista de participantes
                const adminNombre = juegoActual.administrador?.nombre;
                const adminExiste = juegoActual.participantes.some(p => p.nombre === adminNombre);

                // Si el administrador no existe, asignar un administrador temporal
                if (!adminExiste) {
                    alert("El administrador no existe. Se asignarÃ¡ un administrador temporal.");
                    verificarYAsignarAdminTemporal();
                }

                // Actualizar el nombre del administrador en la interfaz
                document.getElementById('nombre-administrador').textContent = juegoActual.administrador.nombre || "Administrador temporal";
              
            
                // Ocultar todas las pantallas especificando los IDs directamente 
                const pantallas = ['inicio','opciones-perfil', 'perfil-juego', 'perfil-personal', 'perfil-administrador', 'perfil-participante-ver', 'perfil-participante', 'perfil-admin-ver']; 
                pantallas.forEach(id => { const element = document.getElementById(id); if (element) { element.classList.add('hidden'); } });
                document.getElementById('pantalla-juego').classList.remove('hidden');
                actualizarListaParticipantes();

                // Mostrar los datos del juego
                document.getElementById('info-codigo-juego').textContent = codigoActual;
                document.getElementById('nombre-grupo-juego').textContent = juegoActual.nombreGrupo;
                document.getElementById('presupuesto-juego').textContent = juegoActual.presupuesto;
                document.getElementById('fecha-sorteo').textContent = window.formatoFecha(juegoActual.fechaSorteo);
                document.getElementById('fecha-entrega').textContent = window.formatoFecha(juegoActual.fechaEntrega);
                document.getElementById('mensaje-juego').textContent = juegoActual.mensaje;
                document.getElementById('nombre-administrador').textContent = juegoActual.administrador.nombre;
            };
               
                           
            window.mostrarOpcionesPerfil = function() {
                    document.getElementById('pantalla-juego').classList.add('hidden');
                    document.getElementById('perfil-administrador').classList.remove('hidden');
                    document.getElementById('opciones-perfil').classList.remove('hidden');
                    document.getElementById('perfil-juego').classList.add('hidden');
                    document.getElementById('perfil-personal').classList.add('hidden');
            };


            window.verPerfilJuego = function() {
                    document.getElementById('opciones-perfil').classList.add('hidden');
                    document.getElementById('inicio').classList.add('hidden');
                    document.getElementById('perfil-juego').classList.remove('hidden');
                    document.getElementById('perfil-personal').classList.add('hidden');
                    document.getElementById('perfil-administrador').classList.add('hidden');
                    document.getElementById('admin-presupuesto-mostrar').value = juegoActual.presupuesto;
                    document.getElementById('admin-fecha-sorteo-mostrar').value = juegoActual.fechaSorteo;
                    document.getElementById('admin-fecha-entrega-mostrar').value = juegoActual.fechaEntrega;
                    document.getElementById('admin-mensaje-mostrar').value = juegoActual.mensaje;
                    actualizarListaParticipantesAdmin();
            };
            window.verPerfilPersonal = function () {
               
                // Verificar si el perfil del administrador estÃ¡ cargado
                if (!juegoActual || !juegoActual.administrador) {
                    alert("No se pudo cargar el perfil del administrador. Verifica tu conexiÃ³n y vuelve a intentarlo.");
                    return;
                }

                // Verificar y ocultar cada pantalla solo si existe
                const pantallas = [
                    'pantalla-juego',
                    'perfil-administrador',
                    'perfil-participante',
                    'opciones-perfil'
                ];

                pantallas.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) {
                        elemento.classList.add('hidden');
                    } else {
                        console.warn(`Elemento con ID "${id}" no encontrado.`);
                    }
                });

                // Mostrar la pantalla del perfil personal
                const perfilPersonal = document.getElementById('perfil-personal');
                if (!perfilPersonal) {
                    console.error('No se encontrÃ³ el elemento con ID "perfil-personal".');
                    return;
                }
                perfilPersonal.classList.remove('hidden');

                // Mostrar los datos del administrador
                const admin = juegoActual.administrador;
                document.getElementById('perfil-nombre').value = admin.nombre || "";
                document.getElementById('perfil-avatar').value = admin.avatar || "";
                document.getElementById('perfil-deseos').value = admin.deseos || "";
                document.getElementById('admin-mensaje').value = admin.mensajeAmigo || "";

            
                // Mostrar el nombre del amigo invisible si se ha realizado el sorteo
                const participante = juegoActual.participantes.find(p => p.nombre === admin.nombre);
                if (participante && participante.amigoInvisible) {
                    const amigoInvisible = juegoActual.participantes.find(p => p.nombre === participante.amigoInvisible);
                    document.getElementById('amigo-invisible-admin').textContent = amigoInvisible ? amigoInvisible.nombre : "Sorteo todavÃ­a no realizado";
                } else {
                    document.getElementById('amigo-invisible-admin').textContent = "Sorteo todavÃ­a no realizado";
                }

               
            };

            window.realizarSorteo = function() {
                    if (juegoActual.participantes.length < 3) {
                        alert("Se necesitan al menos 3 participantes para realizar el sorteo.");
                        return;
                    }

                    if (juegoActual.participantes.some(p => p.amigoInvisible)) {
                        const confirmar = confirm("Sorteo ya realizado. Â¿Quieres volverlo a realizar? Esto cambiarÃ­a los datos de los amigos invisibles de todos los participantes.");
                        if (!confirmar) return;
                    }

                    let nombres = juegoActual.participantes.map(p => p.nombre);
                    let amigosAsignados = [...nombres];

                    do {
                        amigosAsignados = amigosAsignados= [...nombres].sort(() => Math.random() - 0.5);
                    } while (nombres.some((nombre, index) => nombre === amigosAsignados[index]));

                    juegoActual.participantes.forEach((participante, index) => {
                        participante.amigoInvisible = amigosAsignados[index];
                    });

                
                    
                    // Guardar el sorteo en Firestore
                    updateDoc(doc(db, "juegos", String(codigoActual)), {
                        participantes: juegoActual.participantes
                    }).then(() => {
                        alert("Â¡Sorteo realizado con Ã©xito!");
                    }).catch(error => {
                        console.error("Error al realizar el sorteo: ", error);
                    });
            };
 

                          
            window.actualizarJuego = function() {
            
                juegoActual.presupuesto = document.getElementById('admin-presupuesto-mostrar').value;
                juegoActual.fechaSorteo = document.getElementById('admin-fecha-sorteo-mostrar').value;
                juegoActual.fechaEntrega = document.getElementById('admin-fecha-entrega-mostrar').value;
                juegoActual.mensaje = document.getElementById('admin-mensaje-mostrar').value;

            
                // Guardar los cambios en Firestore
                updateDoc(doc(db, "juegos", String(codigoActual)), {
                    presupuesto: juegoActual.presupuesto,
                    fechaSorteo: juegoActual.fechaSorteo,
                    fechaEntrega: juegoActual.fechaEntrega,
                    mensaje: juegoActual.mensaje
                }).then(() => {
                    alert("Â¡InformaciÃ³n del juego actualizada!");
                    mostrarInformacionJuego();  // Redirige a la pantalla de juego
                }).catch(error => {
                    console.error("Error al actualizar el juego: ", error);
                });
            };

            window.actualizarListaParticipantes = function() {
                const lista = document.getElementById('lista-participantes');
                lista.innerHTML = '';
                
                if (juegoActual && Array.isArray(juegoActual.participantes)) {
                    juegoActual.participantes.forEach((participante, index) => {
                        const avatar = participante.avatar || '';
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${avatar} ${participante.nombre}</span>
                            <button class="btn gestionar-perfil-btn" onclick="gestionarPerfil(${index})">GESTIONAR PERFIL</button>
                            <button class="btn ver-perfil-btn" onclick="mostrarDatosPerfilLectura(${index})">VER PERFIL </button>
                        `;
                        lista.appendChild(li);
                    });
                } else {
                    console.error("juegoActual no estÃ¡ definido o participantes no es un arreglo");
                }
            };
 
            window.actualizarListaParticipantesAdmin = function() {
                const lista = document.getElementById('lista-participantes-admin');
                lista.innerHTML = '';
                if (juegoActual && Array.isArray(juegoActual.participantes)) {
                    juegoActual.participantes.forEach((participante, index) => {
                        const avatar = participante.avatar || '';
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${avatar} ${participante.nombre}</span>
                            <button class="btn eliminar-participante-btn" onclick="eliminarParticipante(${index})">ELIMINAR PARTICIPANTE</button>
                        `;
                        lista.appendChild(li);
                    });
                  
                } else {
                    console.error("juegoActual no estÃ¡ definido o participantes no es un arreglo");
                }
            };
         

            // FunciÃ³n para eliminar un participante
            window.eliminarParticipante = function(index) {
                const participante = juegoActual.participantes[index];

                if (participante.esAdministrador) {
                    alert("No se puede eliminar al administrador. Debes transferir el rol antes de eliminarlo.");
                    return;
                }

                const confirmar = confirm(`Â¿EstÃ¡s seguro de que deseas eliminar a ${participante.nombre}?`);
                if (confirmar) {
                    juegoActual.participantes.splice(index, 1);
                    updateDoc(doc(db, "juegos", String(codigoActual)), {
                        participantes: juegoActual.participantes
                    }).then(() => {
                        alert("Participante eliminado con Ã©xito.");
                        actualizarListaParticipantesAdmin();
                    }).catch(error => {
                        console.error("Error al eliminar participante:", error);
                    });
                }
            };


            window.transferirRolAdministrador = function() {
                const participantesSinAdmin = juegoActual.participantes.filter(p => !p.esAdministrador);
                const opciones = participantesSinAdmin.map(p => p.nombre).join("\n");

                const nuevoAdminNombre = prompt(`Elige el participante que recibirÃ¡ el rol de administrador:\n${opciones}`);
                const nuevoAdmin = juegoActual.participantes.find(p => p.nombre === nuevoAdminNombre);

                if (nuevoAdmin) {
                    // Actualizar el nuevo administrador
                    nuevoAdmin.esAdministrador = true;
                    juegoActual.administrador = {
                        nombre: nuevoAdmin.nombre,
                        email: nuevoAdmin.email || "",
                        password: nuevoAdmin.password || "123"
                    };

                    // Eliminar el rol del administrador actual
                    const adminIndex = juegoActual.participantes.findIndex(p => p.esAdministrador);
                    if (adminIndex !== -1) {
                        juegoActual.participantes[adminIndex].esAdministrador = false;
                    }

                    // Guardar los cambios en Firestore
                    updateDoc(doc(db, "juegos", String(codigoActual)), {
                        administrador: juegoActual.administrador,
                        participantes: juegoActual.participantes
                    }).then(() => {
                        alert("El rol de administrador ha sido transferido con Ã©xito.");
                        mostrarInformacionJuego();
                    }).catch(error => {
                        console.error("Error al transferir el rol de administrador:", error);
                    });
                } else {
                    alert("Participante no encontrado. Por favor, intenta de nuevo.");
                }
            };

            //ver sin modificar perfil
            window.mostrarDatosPerfilLectura = function(index) {
                const participante = juegoActual.participantes[index];

                // Verificar si el participante es administrador
                const esAdministrador = (participante.nombre === juegoActual.administrador.nombre);

                if (esAdministrador) {
                    // Mostrar el perfil del administrador
                    document.getElementById('pantalla-juego').classList.add('hidden');
                    document.getElementById('perfil-participante-ver').classList.add('hidden');
                    document.getElementById('perfil-admin-ver').classList.remove('hidden');

                    // Rellenar los datos del perfil del administrador
                    const administrador = juegoActual.administrador;
                    document.getElementById('perfil-nombre-admin-ver').textContent = administrador.nombre;
                    document.getElementById('admin-avatar-ver').value = administrador.avatar || "No hay avatar registrado... aÃºn no ha sido seleccionado.";
                    document.getElementById('admin-deseos-ver').value = administrador.deseos || "No hay deseos escritos... pero pronto estarÃ¡n listos.";
                    document.getElementById('admin-mensaje-ver').value = administrador.mensajeAmigo || "No hay mensaje redactado... eso es porque todavÃ­a no ha sido creado.";
                } else {
                    // Mostrar el perfil del participante
                    document.getElementById('pantalla-juego').classList.add('hidden');
                    document.getElementById('perfil-admin-ver').classList.add('hidden');
                    document.getElementById('perfil-participante-ver').classList.remove('hidden');

                    // Rellenar los datos del perfil del participante
                    document.getElementById('perfil-nombre-participante-ver').textContent = participante.nombre;
                    document.getElementById('participante-avatar-ver').value = participante.avatar || "No hay avatar registrado... aÃºn no ha sido seleccionado.";
                    document.getElementById('participante-deseos-ver').value = participante.deseos || "No hay deseos escritos... pero seguro que pronto estarÃ¡n listos.";
                    document.getElementById('participante-mensaje').value = participante.mensajeAmigo || "No hay mensaje redactado... eso es porque todavÃ­a no ha sido creado.";
                }
            };
            window.gestionarPerfil = function(index) {
                const participante = juegoActual.participantes[index];

                let inputPassword;
                alert("La contraseÃ±a debe tener al menos 3 caracteres."); // Muestra la alerta solo una vez
                do {
                    inputPassword = prompt(`${participante.nombre}, introduce tu clave (o crea una si es la primera vez que estÃ¡s en este enclave.):\nSi no la recuerdas, escribe 'ayuda', y en un abrir y cerrar de ojos se resuelve tu duda.`);
                    
                    if (inputPassword && inputPassword.length >= 3) {
                        break; // Salir del bucle si la contraseÃ±a es vÃ¡lida
                    } else {
                        alert("La contraseÃ±a debe tener al menos 3 caracteres.");
                    }
                } while (true); // Continuar pidiendo hasta que se introduzca una contraseÃ±a vÃ¡lida

                // Verificar si se ha escrito "ayuda"
                if (inputPassword.toLowerCase() === "ayuda") {
                    const esAdministrador = participante.nombre === juegoActual.administrador.nombre;

                    if (esAdministrador) {
                        const email = prompt("Introduce tu email registrado, y tu cÃ³digo serÃ¡ restaurado. ğŸ“§ğŸ”‘:");
                        if (email === juegoActual.administrador.email) {
                            const nuevaPassword = prompt("Introduce tu nueva clave, y tu seguridad serÃ¡ de primera clase. ğŸ”âœ¨");
                            if (nuevaPassword && nuevaPassword.length >= 3) {
                                juegoActual.administrador.password = nuevaPassword;
                                const adminIndex = juegoActual.participantes.findIndex(p => p.nombre === juegoActual.administrador.nombre);
                                if (adminIndex !== -1) {
                                    juegoActual.participantes[adminIndex].password = nuevaPassword;
                                }

                                updateDoc(doc(db, "juegos", String(codigoActual)), {
                                    administrador: juegoActual.administrador,
                                    participantes: juegoActual.participantes
                                }).then(() => {
                                    alert("ContraseÃ±a renovada con destreza, Â¡ahora tu acceso es una proeza! ğŸ”‘âœ¨.");
                                }).catch(error => {
                                    console.error("Error al actualizar la contraseÃ±a en Firebase:", error);
                                });
                            } else {
                                alert("La contraseÃ±a debe tener al menos 3 caracteres.");
                                return;
                            }
                        } else {
                            alert("Tu email no es correcto, Â¡revisa bien el texto!. ğŸ“§âŒ");
                            return;
                        }
                    } else {
                        alert("Â¿Sin clave? No hay problema! Solicita a tu lÃ­der una nueva y se soluciona el dilemağŸ˜Š");
                        const contrasenaBasica = prompt("Introduce la contraseÃ±a que te ha dado tu lÃ­der:");

                        if (contrasenaBasica === "123") {
                            const nuevaPassword = prompt("Crea tu nueva contraseÃ±a ahora y guÃ¡rdala sin demora (mÃ­nimo 3 caracteres):");

                            if (nuevaPassword && nuevaPassword.length >= 3) {
                                participante.password = nuevaPassword;
                                alert("ContraseÃ±a renovada con Ã©xito.");

                                updateDoc(doc(db, "juegos", String(codigoActual)), {
                                    participantes: juegoActual.participantes
                                }).then(() => {
                                   
                                }).catch(error => {
                                    console.error("Error al actualizar la contraseÃ±a en Firebase:", error);
                                });
                            } else {
                                alert("ContraseÃ±a no vÃ¡lida, ha de tener mÃ­nimo 3 caracteres.");
                            }
                        } else {
                            alert("Ups, hay algÃºn problema. Habla con tu admin y soluciona el dilema.");
                            return;
                        }
                    }
                } else {
                    if (participante.password && inputPassword !== participante.password) {
                        alert("ContraseÃ±a incorrecta.");
                        return; // Salir si la contraseÃ±a es incorrecta
                    }
                    if (!participante.password) {
                        if (inputPassword.length < 3) {
                            alert("La contraseÃ±a debe tener al menos 3 caracteres.");
                            return;
                        }
                        participante.password = inputPassword;
                        alert("Â¡ContraseÃ±a creada con Ã©xito!");
                    }
                }

                updateDoc(doc(db, "juegos", String(codigoActual)), {
                    participantes: juegoActual.participantes
                }).then(() => {
                   
                }).catch(error => {
                    console.error("Error al guardar los datos en Firebase:", error);
                });

                const esAdministrador = participante.nombre === juegoActual.administrador.nombre;

                if (esAdministrador) {
                    document.getElementById('pantalla-juego').classList.add('hidden');
                    document.getElementById('perfil-administrador').classList.remove('hidden');
                    document.getElementById('opciones-perfil').classList.remove('hidden');
                } else {
                    document.getElementById('pantalla-juego').classList.add('hidden');
                    document.getElementById('perfil-participante').classList.remove('hidden');

                    document.getElementById('perfil-nombre-participante').textContent = participante.nombre;
                    document.getElementById('participante-avatar').value = participante.avatar || "No hay avatar registrado... aÃºn no lo has seleccionado.";
                    document.getElementById('participante-deseos').value = participante.deseos || "No hay deseos escritos... Â¿a quÃ© esperas para que estÃ©n listos?.";
                    document.getElementById('participante-mensaje2').value = participante.mensajeAmigo || "No hay mensaje redactado con emociÃ³n... Â¿eso es porque todavÃ­a no te ha venido la inspiraciÃ³n?.";
                    const amigoInvisibleNombre = participante.amigoInvisible || "Sorteo todavÃ­a no realizado";
                    document.getElementById('amigo-invisible-participante').textContent = amigoInvisibleNombre;
                }
            };

        

            // FunciÃ³n principal para actualizar el perfil del administrador
            window.actualizarPerfilAdministrador = function() {
                const administrador = juegoActual.administrador;

                if (administrador) {
                    // Verificar la visibilidad del div 'perfil-personal'
                    const perfilPersonalVisible = !document.getElementById('perfil-personal').classList.contains('hidden');
                    console.log("Visibilidad del div 'perfil-personal':", perfilPersonalVisible);

                    const mensajeElemento = document.getElementById('admin-mensaje');
                    if (mensajeElemento) {
                        mensajeElemento.value = mensajeElemento.value.trim();
                        console.log("Valor del elemento mensaje antes de asignar a administrador:", mensajeElemento.value);
                        administrador.mensajeAmigo = mensajeElemento.value;
                        console.log("Valor asignado a 'administrador.mensajeAmigo' despuÃ©s de forzar actualizaciÃ³n:", administrador.mensajeAmigo);
                    } else {
                        console.error("No se encontrÃ³ el elemento con ID 'admin-mensaje'.");
                    }

                    // Asignar valores de avatar y deseos
                    const avatarElemento = document.getElementById('perfil-avatar');
                    if (avatarElemento) {
                        administrador.avatar = avatarElemento.value;
                        console.log("Valor del avatar asignado a administrador:", administrador.avatar);
                    } else {
                        console.error("No se encontrÃ³ el elemento con ID 'perfil-avatar'.");
                    }

                    const deseosElemento = document.getElementById('perfil-deseos');
                    if (deseosElemento) {
                        administrador.deseos = deseosElemento.value;
                        console.log("Valor de deseos asignado a administrador:", administrador.deseos);
                    } else {
                        console.error("No se encontrÃ³ el elemento con ID 'perfil-deseos'.");
                    }

                    // Mostrar el amigo invisible si ya ha sido asignado
                    const amigoInvisible = administrador.amigoInvisible || "Sorteo todavÃ­a no realizado";
                    document.getElementById('amigo-invisible-admin').textContent = amigoInvisible;

                    // Encontrar al administrador en el array de participantes
                    const adminIndex = juegoActual.participantes.findIndex(p => p.nombre === administrador.nombre);
                    if (adminIndex !== -1) {
                        juegoActual.participantes[adminIndex].avatar = administrador.avatar;
                        juegoActual.participantes[adminIndex].deseos = administrador.deseos;
                        juegoActual.participantes[adminIndex].mensajeAmigo = administrador.mensajeAmigo;
                        console.log("Datos del administrador en el array de participantes actualizados:", juegoActual.participantes[adminIndex]);
                    } else {
                        console.error("Administrador no encontrado en el array de participantes");
                    }

                    // Guardar cambios en Firestore
                    const docRef = doc(db, "juegos", String(codigoActual));
                    console.log("Datos del administrador antes de guardar en Firestore:", administrador);

                    updateDoc(docRef, {
                        administrador: administrador,
                        participantes: juegoActual.participantes
                    })
                    .then(() => {
                        console.log("Datos del administrador y participantes actualizados en Firestore");
                        alert("Â¡Perfil del administrador actualizado!");
                    })
                    .catch((error) => {
                        console.error("Error al actualizar el perfil del administrador:", error);
                    });
                }
            };



               // Actualiza los detalles del participante
            window.actualizarPerfilParticipante = function() {
                const participanteNombre = document.getElementById('perfil-nombre-participante').textContent;
              

                const participante = juegoActual.participantes.find(p => p.nombre === participanteNombre);
             
                if (participante) {
                    // Actualiza los detalles del participante
                    participante.avatar = document.getElementById('participante-avatar').value;
                    participante.deseos = document.getElementById('participante-deseos').value;
                    participante.mensajeAmigo = document.getElementById('participante-mensaje2').value;
                    
                   
                   // Mostrar el nombre del amigo invisible o un mensaje si no se ha realizado el sorteo
                   const amigoInvisibleNombre = participante.amigoInvisible || "Sorteo todavÃ­a no realizado";
                    document.getElementById('amigo-invisible-participante').textContent = amigoInvisibleNombre;

                    // Guardar cambios en Firestore
                    const docRef = doc(db, "juegos", String(codigoActual));
                    updateDoc(docRef, { participantes: juegoActual.participantes })
                        .then(() => {
                            alert("Â¡Perfil actualizado!");
                            actualizarListaParticipantes();
                            actualizarListaParticipantesAdmin();
                            // Ocultar el perfil del participante y mostrar el juego
                            document.getElementById('perfil-participante').classList.add('hidden');
                            document.getElementById('pantalla-juego').classList.remove('hidden');
                        })
                        .catch(error => {
                            console.error("Error al actualizar el perfil del participante: ", error);
                        });
                } else {
                    console.error("Participante no encontrado");
                }
            };


            window.eliminarJuego = function() {
                if (confirm("Â¿Seguro que quieres eliminar el juego? PerderÃ¡s toda la informaciÃ³n que has puesto con esmero.")) {
                    // Delete the game from Firestore
                    const docRef = doc(db, "juegos", String(codigoActual));
                    
                    deleteDoc(docRef)
                        .then(() => {
                            alert("Juego eliminado.");

                            // Reset the game variables to ensure no leftover data interferes
                            juegoActual = null;
                            codigoActual = null;

                            // Hide all game-related screens and show the home screen
                            document.getElementById('perfil-administrador').classList.add('hidden');
                            document.getElementById('pantalla-juego').classList.add('hidden');
                            document.getElementById('inicio').classList.remove('hidden');

                            
                        })
                        .catch(error => {
                            console.error("Error al eliminar el juego: ", error);
                            alert("OcurriÃ³ un error al intentar eliminar el juego. Por favor, intÃ©ntalo de nuevo.");
                        });
                };
            };  



          
            window.salirJuego = function() {
                    // ConfirmaciÃ³n antes de salir
                    if (confirm("Â¿EstÃ¡s seguro de que deseas salir del juego y volver al inicio?")) {
                    

                        // Lista completa de IDs de las pantallas a ocultar
                        const idsPantallasOcultar = [
                            'perfil-personal',
                            'pantalla-juego',
                            'perfil-administrador',
                            'insertar-codigo',
                            'nuevo-juego',
                            'opciones-perfil',
                            'perfil-juego',
                            'perfil-participante'
                        ];

                        // Ocultar todas las pantallas de la lista
                        idsPantallasOcultar.forEach(id => {
                            const elemento = document.getElementById(id);
                            if (elemento) {
                                elemento.classList.add('hidden');
                              
                            }
                        });

                        // Mostrar la pantalla de inicio
                        const pantallaInicio = document.getElementById('inicio');
                        if (pantallaInicio) {
                            pantallaInicio.classList.remove('hidden');
                           
                        }
                    }
            };
      
                    // Asignar el evento al botÃ³n de "Gestionar tu perfil PERSONAL"
            document.addEventListener("DOMContentLoaded", function () {
                const btnVerPerfilPersonal = document.getElementById('btn-ver-perfil-personal');

                if (btnVerPerfilPersonal) {
                    btnVerPerfilPersonal.onclick = function () {
                       
                        verPerfilPersonal();
                    };
                } else {
                    console.error("BotÃ³n 'Gestionar tu perfil PERSONAL' no encontrado.");
                }
            });
       
            

        </script>
    </div>
</body>
</html>

